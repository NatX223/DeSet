import { ethers } from "ethers";
import { Database, helpers } from "@tableland/sdk";
import { routerABI } from "./RouterABI";
import { formABI } from "./formABI";
import { controllerABI } from "./controllerABI";
import axios from 'axios';
import { Web3Storage } from "web3.storage";
import { marketABI } from "./marketplaceABI";

require("dotenv").config();

const bytecode = "60806040523480156200001157600080fd5b50604051620054d1380380620054d183398181016040528101906200003791906200028e565b6040518060400160405280600481526020017f68617368000000000000000000000000000000000000000000000000000000008152506200007e816200020f60201b60201c565b5033600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555083600860006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600760006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600960006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050505062000661565b80600290816200022091906200057a565b5050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620002568262000229565b9050919050565b620002688162000249565b81146200027457600080fd5b50565b60008151905062000288816200025d565b92915050565b60008060008060808587031215620002ab57620002aa62000224565b5b6000620002bb8782880162000277565b9450506020620002ce8782880162000277565b9350506040620002e18782880162000277565b9250506060620002f48782880162000277565b91505092959194509250565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200038257607f821691505b6020821081036200039857620003976200033a565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620004027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620003c3565b6200040e8683620003c3565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006200045b620004556200044f8462000426565b62000430565b62000426565b9050919050565b6000819050919050565b62000477836200043a565b6200048f620004868262000462565b848454620003d0565b825550505050565b600090565b620004a662000497565b620004b38184846200046c565b505050565b5b81811015620004db57620004cf6000826200049c565b600181019050620004b9565b5050565b601f8211156200052a57620004f4816200039e565b620004ff84620003b3565b810160208510156200050f578190505b620005276200051e85620003b3565b830182620004b8565b50505b505050565b600082821c905092915050565b60006200054f600019846008026200052f565b1980831691505092915050565b60006200056a83836200053c565b9150826002028217905092915050565b620005858262000300565b67ffffffffffffffff811115620005a157620005a06200030b565b5b620005ad825462000369565b620005ba828285620004df565b600060209050601f831160018114620005f25760008415620005dd578287015190505b620005e985826200055c565b86555062000659565b601f19841662000602866200039e565b60005b828110156200062c5784890151825560018201915060208501945060208101905062000605565b868310156200064c578489015162000648601f8916826200053c565b8355505b6001600288020188555050505b505050505050565b614e6080620006716000396000f3fe6080604052600436106101285760003560e01c80634e1273f4116100ab578063a22cb4651161006f578063a22cb4651461040e578063a87d942c14610437578063b504b0b114610462578063b5a01c4e1461049f578063e985e9c5146104ca578063f242432a1461050757610128565b80634e1273f41461033657806381909ebb146103735780638da5cb5b1461038f57806395623641146103ba5780639fe1c16e146103e557610128565b80630e89341c116100f25780630e89341c14610236578063150b7a0214610273578063195e251f146102b05780632eb2c2d6146102f1578063399874481461031a57610128565b806263bdac1461012d578062fdd58e1461016a57806301a20866146101a757806301ffc9a7146101d05780630a531dfd1461020d575b600080fd5b34801561013957600080fd5b50610154600480360381019061014f9190612d2b565b610530565b6040516101619190612de8565b60405180910390f35b34801561017657600080fd5b50610191600480360381019061018c9190612e68565b6105d8565b60405161019e9190612eb7565b60405180910390f35b3480156101b357600080fd5b506101ce60048036038101906101c99190612ed2565b6106a0565b005b3480156101dc57600080fd5b506101f760048036038101906101f29190612f6a565b6108b4565b6040516102049190612fb2565b60405180910390f35b34801561021957600080fd5b50610234600480360381019061022f9190613102565b610996565b005b34801561024257600080fd5b5061025d60048036038101906102589190612d2b565b610d21565b60405161026a9190612de8565b60405180910390f35b34801561027f57600080fd5b5061029a6004803603810190610295919061327a565b610db5565b6040516102a7919061330c565b60405180910390f35b3480156102bc57600080fd5b506102d760048036038101906102d29190612d2b565b610dc9565b6040516102e8959493929190613327565b60405180910390f35b3480156102fd57600080fd5b5061031860048036038101906103139190613457565b610ff6565b005b610334600480360381019061032f9190613607565b611097565b005b34801561034257600080fd5b5061035d60048036038101906103589190613726565b6115f0565b60405161036a919061385c565b60405180910390f35b61038d60048036038101906103889190612ed2565b611709565b005b34801561039b57600080fd5b506103a461179d565b6040516103b1919061388d565b60405180910390f35b3480156103c657600080fd5b506103cf6117c3565b6040516103dc919061388d565b60405180910390f35b3480156103f157600080fd5b5061040c600480360381019061040791906138a8565b6117e9565b005b34801561041a57600080fd5b5061043560048036038101906104309190613914565b6118d3565b005b34801561044357600080fd5b5061044c6118e9565b6040516104599190612eb7565b60405180910390f35b34801561046e57600080fd5b5061048960048036038101906104849190612d2b565b6118fa565b6040516104969190612de8565b60405180910390f35b3480156104ab57600080fd5b506104b461199f565b6040516104c1919061388d565b60405180910390f35b3480156104d657600080fd5b506104f160048036038101906104ec9190613954565b6119c5565b6040516104fe9190612fb2565b60405180910390f35b34801561051357600080fd5b5061052e60048036038101906105299190613994565b611a59565b005b6060600a6000838152602001908152602001600020600301805461055390613a5a565b80601f016020809104026020016040519081016040528092919081815260200182805461057f90613a5a565b80156105cc5780601f106105a1576101008083540402835291602001916105cc565b820191906000526020600020905b8154815290600101906020018083116105af57829003601f168201915b50505050509050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610648576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161063f90613afd565b60405180910390fd5b60008083815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106fa57600080fd5b600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630dd3b57982600a6000868152602001908152602001600020600101543330600a600089815260200190815260200160002060050154600a60008a8152602001908152602001600020600201600a60008b81526020019081526020016000206004016040518863ffffffff1660e01b81526004016107b79796959493929190613bb6565b600060405180830381600087803b1580156107d157600080fd5b505af11580156107e5573d6000803e3d6000fd5b50505050600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663095ea7b3600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600a6000868152602001908152602001600020600101546040518363ffffffff1660e01b815260040161087e929190613c33565b600060405180830381600087803b15801561089857600080fd5b505af11580156108ac573d6000803e3d6000fd5b505050505050565b60007fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061097f57507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b8061098f575061098e82611afa565b5b9050919050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146109f057600080fd5b60006109fa611b64565b73ffffffffffffffffffffffffffffffffffffffff1663a15ab08d30610a3f87604051602001610a2a9190613cbe565b60405160208183030381529060405289611d63565b6040518363ffffffff1660e01b8152600401610a5c929190613ce4565b6020604051808303816000875af1158015610a7b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a9f9190613d29565b9050600085610aad46611d99565b610ab684611d99565b604051602001610ac893929190613d7c565b604051602081830303815290604052905083600a6000610ae86003611e67565b81526020019081526020016000206004019081610b059190613f62565b5085600a6000610b156003611e67565b81526020019081526020016000206002019081610b329190613f62565b50610b3d6003611e67565b600a6000610b4b6003611e67565b81526020019081526020016000206000018190555081600a6000610b6f6003611e67565b81526020019081526020016000206001018190555080600a6000610b936003611e67565b81526020019081526020016000206003019081610bb09190613f62565b50610bb9611b64565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab973084600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b8152600401610c1793929190614034565b600060405180830381600087803b158015610c3157600080fd5b505af1158015610c45573d6000803e3d6000fd5b5050505082600c6000610c586003611e67565b81526020019081526020016000209081610c729190613f62565b50600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16633db88432338830610cbe6003611e67565b6040518563ffffffff1660e01b8152600401610cdd949392919061406b565b600060405180830381600087803b158015610cf757600080fd5b505af1158015610d0b573d6000803e3d6000fd5b50505050610d196003611e75565b505050505050565b606060028054610d3090613a5a565b80601f0160208091040260200160405190810160405280929190818152602001828054610d5c90613a5a565b8015610da95780601f10610d7e57610100808354040283529160200191610da9565b820191906000526020600020905b815481529060010190602001808311610d8c57829003601f168201915b50505050509050919050565b600063150b7a0260e01b9050949350505050565b600060608060606000600a600087815260200190815260200160002060000154600a6000888152602001908152602001600020600201600a6000898152602001908152602001600020600401600c60008a8152602001908152602001600020600a60008b815260200190815260200160002060050154838054610e4b90613a5a565b80601f0160208091040260200160405190810160405280929190818152602001828054610e7790613a5a565b8015610ec45780601f10610e9957610100808354040283529160200191610ec4565b820191906000526020600020905b815481529060010190602001808311610ea757829003601f168201915b50505050509350828054610ed790613a5a565b80601f0160208091040260200160405190810160405280929190818152602001828054610f0390613a5a565b8015610f505780601f10610f2557610100808354040283529160200191610f50565b820191906000526020600020905b815481529060010190602001808311610f3357829003601f168201915b50505050509250818054610f6390613a5a565b80601f0160208091040260200160405190810160405280929190818152602001828054610f8f90613a5a565b8015610fdc5780601f10610fb157610100808354040283529160200191610fdc565b820191906000526020600020905b815481529060010190602001808311610fbf57829003601f168201915b505050505091509450945094509450945091939590929450565b610ffe611e8b565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16148061104457506110438561103e611e8b565b6119c5565b5b611083576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161107a90614129565b60405180910390fd5b6110908585858585611e93565b5050505050565b60006110a2826121b4565b90506000600c600085815260200190815260200160002080546110c490613a5a565b80601f01602080910402602001604051908101604052809291908181526020018280546110f090613a5a565b801561113d5780601f106111125761010080835404028352916020019161113d565b820191906000526020600020905b81548152906001019060200180831161112057829003601f168201915b50505050509050600b6000858152602001908152602001600020600101544711801561117f57506000600b600086815260200190815260200160002060000154115b156114115761118c611b64565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da3430600a6000898152602001908152602001600020600101546112de600a60008b815260200190815260200160002060020180546111e490613a5a565b80601f016020809104026020016040519081016040528092919081815260200182805461121090613a5a565b801561125d5780601f106112325761010080835404028352916020019161125d565b820191906000526020600020905b81548152906001019060200180831161124057829003601f168201915b5050505050600a60008c8152602001908152602001600020600101548860405160200161128a919061416f565b6040516020818303038152906040526112b8600a60008f815260200190815260200160002060050154611d99565b8b6040516020016112ca9291906141bb565b604051602081830303815290604052612286565b6040518563ffffffff1660e01b81526004016112fc939291906141ee565b6000604051808303818588803b15801561131557600080fd5b505af1158015611329573d6000803e3d6000fd5b50505050506000803373ffffffffffffffffffffffffffffffffffffffff16346040516113559061425d565b60006040518083038185875af1925050503d8060008114611392576040519150601f19603f3d011682016040523d82523d6000602084013e611397565b606091505b5091509150816113dc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113d3906142be565b60405180910390fd5b6001600a60008881526020019081526020016000206005016000828254611403919061430d565b9250508190555050506115ea565b611419611b64565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da3430600a60008981526020019081526020016000206001015461156b600a60008b8152602001908152602001600020600201805461147190613a5a565b80601f016020809104026020016040519081016040528092919081815260200182805461149d90613a5a565b80156114ea5780601f106114bf576101008083540402835291602001916114ea565b820191906000526020600020905b8154815290600101906020018083116114cd57829003601f168201915b5050505050600a60008c81526020019081526020016000206001015488604051602001611517919061416f565b604051602081830303815290604052611545600a60008f815260200190815260200160002060050154611d99565b8b6040516020016115579291906141bb565b604051602081830303815290604052612286565b6040518563ffffffff1660e01b8152600401611589939291906141ee565b6000604051808303818588803b1580156115a257600080fd5b505af11580156115b6573d6000803e3d6000fd5b50505050506001600a600086815260200190815260200160002060050160008282546115e2919061430d565b925050819055505b50505050565b60608151835114611636576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161162d906143b3565b60405180910390fd5b6000835167ffffffffffffffff81111561165357611652612fd7565b5b6040519080825280602002602001820160405280156116815781602001602082028036833780820191505090505b50905060005b84518110156116fe576116ce8582815181106116a6576116a56143d3565b5b60200260200101518583815181106116c1576116c06143d3565b5b60200260200101516105d8565b8282815181106116e1576116e06143d3565b5b602002602001018181525050806116f790614402565b9050611687565b508091505092915050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461176357600080fd5b34600b60008481526020019081526020016000206000018190555080600b6000848152602001908152602001600020600101819055505050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461184357600080fd5b61184b611b64565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab9730600a600086815260200190815260200160002060010154846040518463ffffffff1660e01b815260040161189d93929190614034565b600060405180830381600087803b1580156118b757600080fd5b505af11580156118cb573d6000803e3d6000fd5b505050505050565b6118e56118de611e8b565b83836122c5565b5050565b60006118f56003611e67565b905090565b6060600c6000838152602001908152602001600020805461191a90613a5a565b80601f016020809104026020016040519081016040528092919081815260200182805461194690613a5a565b80156119935780601f1061196857610100808354040283529160200191611993565b820191906000526020600020905b81548152906001019060200180831161197657829003601f168201915b50505050509050919050565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b611a61611e8b565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480611aa75750611aa685611aa1611e8b565b6119c5565b5b611ae6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611add90614129565b60405180910390fd5b611af38585858585612431565b5050505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b600060014603611b8a5773012969f7e3439a9b04025b5a049eb9bad82a8c129050611d60565b600a4603611bae5773fad44bf5b843de943a09d4f3e84949a11d3aa3e69050611d60565b61a4b14603611bd357739abd75e8640871a5a20d3b4ee6330a04c962affd9050611d60565b61a4ba4603611bf857731a22854c5b1642760a827f20137a67930ae108d29050611d60565b60894603611c1c57735c4e6a9e5c1e1bf445a062006faf19ea6c49afea9050611d60565b61013a4603611c41577359ef8bf2d6c102b4c42aef9189e1a9f0abfd652d9050611d60565b62aa36a74603611c675773c50c62498448acc8dbde43da77f8d5d2e2c7597d9050611d60565b6101a44603611c8c5773c72e8a7be04f2469f8c2db3f1bdf69a7d516abba9050611d60565b62066eed4603611cb25773033f69e8d119205089ab15d340f5b797732f646b9050611d60565b620138814603611cd857734b48841d4b32c4650e4abc117a03fe8b51f38f689050611d60565b6204cb2f4603611cfe5773030bcf3d50cad04c2e57391b12740982a93086219050611d60565b617a694603611d235773e7f1725e7734ce288f8367e1bb143e90bb3f05129050611d60565b466040517f264e42cf000000000000000000000000000000000000000000000000000000008152600401611d579190612eb7565b60405180910390fd5b90565b606081611d6f46611d99565b84604051602001611d829392919061457a565b604051602081830303815290604052905092915050565b606060006001611da8846126cc565b01905060008167ffffffffffffffff811115611dc757611dc6612fd7565b5b6040519080825280601f01601f191660200182016040528015611df95781602001600182028036833780820191505090505b509050600082602001820190505b600115611e5c578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a8581611e5057611e4f6145d7565b5b04945060008503611e07575b819350505050919050565b600081600001549050919050565b6001816000016000828254019250508190555050565b600033905090565b8151835114611ed7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ece90614678565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603611f46576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f3d9061470a565b60405180910390fd5b6000611f50611e8b565b9050611f6081878787878761281f565b60005b8451811015612111576000858281518110611f8157611f806143d3565b5b602002602001015190506000858381518110611fa057611f9f6143d3565b5b60200260200101519050600080600084815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015612041576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016120389061479c565b60405180910390fd5b81810360008085815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160008085815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546120f6919061430d565b925050819055505050508061210a90614402565b9050611f63565b508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb87876040516121889291906147bc565b60405180910390a461219e818787878787612827565b6121ac81878787878761282f565b505050505050565b60608060005b835181101561227c57600184516121d191906147f3565b810361222257816121fb8583815181106121ee576121ed6143d3565b5b6020026020010151612a06565b60405160200161220c929190614827565b6040516020818303038152906040529150612269565b81612246858381518110612239576122386143d3565b5b6020026020010151612a06565b60405160200161225792919061484b565b60405160208183030381529060405291505b808061227490614402565b9150506121ba565b5080915050919050565b606060006122948686612a2f565b90508084846040516020016122ab93929190614916565b604051602081830303815290604052915050949350505050565b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603612333576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161232a906149e5565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31836040516124249190612fb2565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036124a0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016124979061470a565b60405180910390fd5b60006124aa611e8b565b905060006124b785612a6d565b905060006124c485612a6d565b90506124d483898985858961281f565b600080600088815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490508581101561256b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016125629061479c565b60405180910390fd5b85810360008089815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508560008089815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254612620919061430d565b925050819055508773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628a8a60405161269d929190614a05565b60405180910390a46126b3848a8a86868a612827565b6126c1848a8a8a8a8a612ae7565b505050505050505050565b600080600090507a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000831061272a577a184f03e93ff9f4daa797ed6e38ed64bf6a1f01000000000000000083816127205761271f6145d7565b5b0492506040810190505b6d04ee2d6d415b85acef81000000008310612767576d04ee2d6d415b85acef8100000000838161275d5761275c6145d7565b5b0492506020810190505b662386f26fc10000831061279657662386f26fc10000838161278c5761278b6145d7565b5b0492506010810190505b6305f5e10083106127bf576305f5e10083816127b5576127b46145d7565b5b0492506008810190505b61271083106127e45761271083816127da576127d96145d7565b5b0492506004810190505b6064831061280757606483816127fd576127fc6145d7565b5b0492506002810190505b600a8310612816576001810190505b80915050919050565b505050505050565b505050505050565b61284e8473ffffffffffffffffffffffffffffffffffffffff16612cbe565b156129fe578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b8152600401612894959493929190614a83565b6020604051808303816000875af19250505080156128d057506040513d601f19601f820116820180604052508101906128cd9190614b00565b60015b612975576128dc614b3a565b806308c379a00361293857506128f0614b5c565b806128fb575061293a565b806040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161292f9190612de8565b60405180910390fd5b505b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161296c90614c5e565b60405180910390fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916146129fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016129f390614cf0565b60405180910390fd5b505b505050505050565b606081604051602001612a199190614d5c565b6040516020818303038152906040529050919050565b606082612a3b46611d99565b612a4484611d99565b604051602001612a5693929190614d89565b604051602081830303815290604052905092915050565b60606000600167ffffffffffffffff811115612a8c57612a8b612fd7565b5b604051908082528060200260200182016040528015612aba5781602001602082028036833780820191505090505b5090508281600081518110612ad257612ad16143d3565b5b60200260200101818152505080915050919050565b612b068473ffffffffffffffffffffffffffffffffffffffff16612cbe565b15612cb6578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b8152600401612b4c959493929190614dd0565b6020604051808303816000875af1925050508015612b8857506040513d601f19601f82011682018060405250810190612b859190614b00565b60015b612c2d57612b94614b3a565b806308c379a003612bf05750612ba8614b5c565b80612bb35750612bf2565b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612be79190612de8565b60405180910390fd5b505b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612c2490614c5e565b60405180910390fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614612cb4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612cab90614cf0565b60405180910390fd5b505b505050505050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b612d0881612cf5565b8114612d1357600080fd5b50565b600081359050612d2581612cff565b92915050565b600060208284031215612d4157612d40612ceb565b5b6000612d4f84828501612d16565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015612d92578082015181840152602081019050612d77565b60008484015250505050565b6000601f19601f8301169050919050565b6000612dba82612d58565b612dc48185612d63565b9350612dd4818560208601612d74565b612ddd81612d9e565b840191505092915050565b60006020820190508181036000830152612e028184612daf565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000612e3582612e0a565b9050919050565b612e4581612e2a565b8114612e5057600080fd5b50565b600081359050612e6281612e3c565b92915050565b60008060408385031215612e7f57612e7e612ceb565b5b6000612e8d85828601612e53565b9250506020612e9e85828601612d16565b9150509250929050565b612eb181612cf5565b82525050565b6000602082019050612ecc6000830184612ea8565b92915050565b60008060408385031215612ee957612ee8612ceb565b5b6000612ef785828601612d16565b9250506020612f0885828601612d16565b9150509250929050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b612f4781612f12565b8114612f5257600080fd5b50565b600081359050612f6481612f3e565b92915050565b600060208284031215612f8057612f7f612ceb565b5b6000612f8e84828501612f55565b91505092915050565b60008115159050919050565b612fac81612f97565b82525050565b6000602082019050612fc76000830184612fa3565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61300f82612d9e565b810181811067ffffffffffffffff8211171561302e5761302d612fd7565b5b80604052505050565b6000613041612ce1565b905061304d8282613006565b919050565b600067ffffffffffffffff82111561306d5761306c612fd7565b5b61307682612d9e565b9050602081019050919050565b82818337600083830152505050565b60006130a56130a084613052565b613037565b9050828152602081018484840111156130c1576130c0612fd2565b5b6130cc848285613083565b509392505050565b600082601f8301126130e9576130e8612fcd565b5b81356130f9848260208601613092565b91505092915050565b6000806000806080858703121561311c5761311b612ceb565b5b600085013567ffffffffffffffff81111561313a57613139612cf0565b5b613146878288016130d4565b945050602085013567ffffffffffffffff81111561316757613166612cf0565b5b613173878288016130d4565b935050604085013567ffffffffffffffff81111561319457613193612cf0565b5b6131a0878288016130d4565b925050606085013567ffffffffffffffff8111156131c1576131c0612cf0565b5b6131cd878288016130d4565b91505092959194509250565b600067ffffffffffffffff8211156131f4576131f3612fd7565b5b6131fd82612d9e565b9050602081019050919050565b600061321d613218846131d9565b613037565b90508281526020810184848401111561323957613238612fd2565b5b613244848285613083565b509392505050565b600082601f83011261326157613260612fcd565b5b813561327184826020860161320a565b91505092915050565b6000806000806080858703121561329457613293612ceb565b5b60006132a287828801612e53565b94505060206132b387828801612e53565b93505060406132c487828801612d16565b925050606085013567ffffffffffffffff8111156132e5576132e4612cf0565b5b6132f18782880161324c565b91505092959194509250565b61330681612f12565b82525050565b600060208201905061332160008301846132fd565b92915050565b600060a08201905061333c6000830188612ea8565b818103602083015261334e8187612daf565b905081810360408301526133628186612daf565b905081810360608301526133768185612daf565b90506133856080830184612ea8565b9695505050505050565b600067ffffffffffffffff8211156133aa576133a9612fd7565b5b602082029050602081019050919050565b600080fd5b60006133d36133ce8461338f565b613037565b905080838252602082019050602084028301858111156133f6576133f56133bb565b5b835b8181101561341f578061340b8882612d16565b8452602084019350506020810190506133f8565b5050509392505050565b600082601f83011261343e5761343d612fcd565b5b813561344e8482602086016133c0565b91505092915050565b600080600080600060a0868803121561347357613472612ceb565b5b600061348188828901612e53565b955050602061349288828901612e53565b945050604086013567ffffffffffffffff8111156134b3576134b2612cf0565b5b6134bf88828901613429565b935050606086013567ffffffffffffffff8111156134e0576134df612cf0565b5b6134ec88828901613429565b925050608086013567ffffffffffffffff81111561350d5761350c612cf0565b5b6135198882890161324c565b9150509295509295909350565b600067ffffffffffffffff82111561354157613540612fd7565b5b602082029050602081019050919050565b600061356561356084613526565b613037565b90508083825260208201905060208402830185811115613588576135876133bb565b5b835b818110156135cf57803567ffffffffffffffff8111156135ad576135ac612fcd565b5b8086016135ba89826130d4565b8552602085019450505060208101905061358a565b5050509392505050565b600082601f8301126135ee576135ed612fcd565b5b81356135fe848260208601613552565b91505092915050565b6000806040838503121561361e5761361d612ceb565b5b600061362c85828601612d16565b925050602083013567ffffffffffffffff81111561364d5761364c612cf0565b5b613659858286016135d9565b9150509250929050565b600067ffffffffffffffff82111561367e5761367d612fd7565b5b602082029050602081019050919050565b60006136a261369d84613663565b613037565b905080838252602082019050602084028301858111156136c5576136c46133bb565b5b835b818110156136ee57806136da8882612e53565b8452602084019350506020810190506136c7565b5050509392505050565b600082601f83011261370d5761370c612fcd565b5b813561371d84826020860161368f565b91505092915050565b6000806040838503121561373d5761373c612ceb565b5b600083013567ffffffffffffffff81111561375b5761375a612cf0565b5b613767858286016136f8565b925050602083013567ffffffffffffffff81111561378857613787612cf0565b5b61379485828601613429565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6137d381612cf5565b82525050565b60006137e583836137ca565b60208301905092915050565b6000602082019050919050565b60006138098261379e565b61381381856137a9565b935061381e836137ba565b8060005b8381101561384f57815161383688826137d9565b9750613841836137f1565b925050600181019050613822565b5085935050505092915050565b6000602082019050818103600083015261387681846137fe565b905092915050565b61388781612e2a565b82525050565b60006020820190506138a2600083018461387e565b92915050565b600080604083850312156138bf576138be612ceb565b5b60006138cd85828601612d16565b92505060206138de85828601612e53565b9150509250929050565b6138f181612f97565b81146138fc57600080fd5b50565b60008135905061390e816138e8565b92915050565b6000806040838503121561392b5761392a612ceb565b5b600061393985828601612e53565b925050602061394a858286016138ff565b9150509250929050565b6000806040838503121561396b5761396a612ceb565b5b600061397985828601612e53565b925050602061398a85828601612e53565b9150509250929050565b600080600080600060a086880312156139b0576139af612ceb565b5b60006139be88828901612e53565b95505060206139cf88828901612e53565b94505060406139e088828901612d16565b93505060606139f188828901612d16565b925050608086013567ffffffffffffffff811115613a1257613a11612cf0565b5b613a1e8882890161324c565b9150509295509295909350565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680613a7257607f821691505b602082108103613a8557613a84613a2b565b5b50919050565b7f455243313135353a2061646472657373207a65726f206973206e6f742061207660008201527f616c6964206f776e657200000000000000000000000000000000000000000000602082015250565b6000613ae7602a83612d63565b9150613af282613a8b565b604082019050919050565b60006020820190508181036000830152613b1681613ada565b9050919050565b60008190508160005260206000209050919050565b60008154613b3f81613a5a565b613b498186612d63565b94506001821660008114613b645760018114613b7a57613bad565b60ff198316865281151560200286019350613bad565b613b8385613b1d565b60005b83811015613ba557815481890152600182019150602081019050613b86565b808801955050505b50505092915050565b600060e082019050613bcb600083018a612ea8565b613bd86020830189612ea8565b613be5604083018861387e565b613bf2606083018761387e565b613bff6080830186612ea8565b81810360a0830152613c118185613b32565b905081810360c0830152613c258184613b32565b905098975050505050505050565b6000604082019050613c48600083018561387e565b613c556020830184612ea8565b9392505050565b7f696420696e7465676572207072696d617279206b65792c000000000000000000815250565b600081905092915050565b6000613c9882612d58565b613ca28185613c82565b9350613cb2818560208601612d74565b80840191505092915050565b6000613cc982613c5c565b601782019150613cd98284613c8d565b915081905092915050565b6000604082019050613cf9600083018561387e565b8181036020830152613d0b8184612daf565b90509392505050565b600081519050613d2381612cff565b92915050565b600060208284031215613d3f57613d3e612ceb565b5b6000613d4d84828501613d14565b91505092915050565b7f5f00000000000000000000000000000000000000000000000000000000000000815250565b6000613d888286613c8d565b9150613d9382613d56565b600182019150613da38285613c8d565b9150613dae82613d56565b600182019150613dbe8284613c8d565b9150819050949350505050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613e187fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613ddb565b613e228683613ddb565b95508019841693508086168417925050509392505050565b6000819050919050565b6000613e5f613e5a613e5584612cf5565b613e3a565b612cf5565b9050919050565b6000819050919050565b613e7983613e44565b613e8d613e8582613e66565b848454613de8565b825550505050565b600090565b613ea2613e95565b613ead818484613e70565b505050565b5b81811015613ed157613ec6600082613e9a565b600181019050613eb3565b5050565b601f821115613f1657613ee781613b1d565b613ef084613dcb565b81016020851015613eff578190505b613f13613f0b85613dcb565b830182613eb2565b50505b505050565b600082821c905092915050565b6000613f3960001984600802613f1b565b1980831691505092915050565b6000613f528383613f28565b9150826002028217905092915050565b613f6b82612d58565b67ffffffffffffffff811115613f8457613f83612fd7565b5b613f8e8254613a5a565b613f99828285613ed5565b600060209050601f831160018114613fcc5760008415613fba578287015190505b613fc48582613f46565b86555061402c565b601f198416613fda86613b1d565b60005b8281101561400257848901518255600182019150602085019450602081019050613fdd565b8683101561401f578489015161401b601f891682613f28565b8355505b6001600288020188555050505b505050505050565b6000606082019050614049600083018661387e565b6140566020830185612ea8565b614063604083018461387e565b949350505050565b6000608082019050614080600083018761387e565b81810360208301526140928186612daf565b90506140a1604083018561387e565b6140ae6060830184612ea8565b95945050505050565b7f455243313135353a2063616c6c6572206973206e6f7420746f6b656e206f776e60008201527f6572206f7220617070726f766564000000000000000000000000000000000000602082015250565b6000614113602e83612d63565b915061411e826140b7565b604082019050919050565b6000602082019050818103600083015261414281614106565b9050919050565b7f69642c0000000000000000000000000000000000000000000000000000000000815250565b600061417a82614149565b60038201915061418a8284613c8d565b915081905092915050565b7f2c00000000000000000000000000000000000000000000000000000000000000815250565b60006141c78285613c8d565b91506141d282614195565b6001820191506141e28284613c8d565b91508190509392505050565b6000606082019050614203600083018661387e565b6142106020830185612ea8565b81810360408301526142228184612daf565b9050949350505050565b600081905092915050565b50565b600061424760008361422c565b915061425282614237565b600082019050919050565b60006142688261423a565b9150819050919050565b7f4661696c656420746f2073656e64204574686572000000000000000000000000600082015250565b60006142a8601483612d63565b91506142b382614272565b602082019050919050565b600060208201905081810360008301526142d78161429b565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061431882612cf5565b915061432383612cf5565b925082820190508082111561433b5761433a6142de565b5b92915050565b7f455243313135353a206163636f756e747320616e6420696473206c656e67746860008201527f206d69736d617463680000000000000000000000000000000000000000000000602082015250565b600061439d602983612d63565b91506143a882614341565b604082019050919050565b600060208201905081810360008301526143cc81614390565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061440d82612cf5565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361443f5761443e6142de565b5b600182019050919050565b7f435245415445205441424c452000000000000000000000000000000000000000600082015250565b6000614480600d83613c82565b915061448b8261444a565b600d82019050919050565b7f5f00000000000000000000000000000000000000000000000000000000000000600082015250565b60006144cc600183613c82565b91506144d782614496565b600182019050919050565b7f2800000000000000000000000000000000000000000000000000000000000000600082015250565b6000614518600183613c82565b9150614523826144e2565b600182019050919050565b7f2900000000000000000000000000000000000000000000000000000000000000600082015250565b6000614564600183613c82565b915061456f8261452e565b600182019050919050565b600061458582614473565b91506145918286613c8d565b915061459c826144bf565b91506145a88285613c8d565b91506145b38261450b565b91506145bf8284613c8d565b91506145ca82614557565b9150819050949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060008201527f6d69736d61746368000000000000000000000000000000000000000000000000602082015250565b6000614662602883612d63565b915061466d82614606565b604082019050919050565b6000602082019050818103600083015261469181614655565b9050919050565b7f455243313135353a207472616e7366657220746f20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b60006146f4602583612d63565b91506146ff82614698565b604082019050919050565b60006020820190508181036000830152614723816146e7565b9050919050565b7f455243313135353a20696e73756666696369656e742062616c616e636520666f60008201527f72207472616e7366657200000000000000000000000000000000000000000000602082015250565b6000614786602a83612d63565b91506147918261472a565b604082019050919050565b600060208201905081810360008301526147b581614779565b9050919050565b600060408201905081810360008301526147d681856137fe565b905081810360208301526147ea81846137fe565b90509392505050565b60006147fe82612cf5565b915061480983612cf5565b9250828203905081811115614821576148206142de565b5b92915050565b60006148338285613c8d565b915061483f8284613c8d565b91508190509392505050565b60006148578285613c8d565b91506148638284613c8d565b915061486e82614195565b6001820191508190509392505050565b7f494e5345525420494e544f200000000000000000000000000000000000000000600082015250565b60006148b4600c83613c82565b91506148bf8261487e565b600c82019050919050565b7f2956414c55455328000000000000000000000000000000000000000000000000600082015250565b6000614900600883613c82565b915061490b826148ca565b600882019050919050565b6000614921826148a7565b915061492d8286613c8d565b91506149388261450b565b91506149448285613c8d565b915061494f826148f3565b915061495b8284613c8d565b915061496682614557565b9150819050949350505050565b7f455243313135353a2073657474696e6720617070726f76616c2073746174757360008201527f20666f722073656c660000000000000000000000000000000000000000000000602082015250565b60006149cf602983612d63565b91506149da82614973565b604082019050919050565b600060208201905081810360008301526149fe816149c2565b9050919050565b6000604082019050614a1a6000830185612ea8565b614a276020830184612ea8565b9392505050565b600081519050919050565b600082825260208201905092915050565b6000614a5582614a2e565b614a5f8185614a39565b9350614a6f818560208601612d74565b614a7881612d9e565b840191505092915050565b600060a082019050614a98600083018861387e565b614aa5602083018761387e565b8181036040830152614ab781866137fe565b90508181036060830152614acb81856137fe565b90508181036080830152614adf8184614a4a565b90509695505050505050565b600081519050614afa81612f3e565b92915050565b600060208284031215614b1657614b15612ceb565b5b6000614b2484828501614aeb565b91505092915050565b60008160e01c9050919050565b600060033d1115614b595760046000803e614b56600051614b2d565b90505b90565b600060443d10614be957614b6e612ce1565b60043d036004823e80513d602482011167ffffffffffffffff82111715614b96575050614be9565b808201805167ffffffffffffffff811115614bb45750505050614be9565b80602083010160043d038501811115614bd1575050505050614be9565b614be082602001850186613006565b82955050505050505b90565b7f455243313135353a207472616e7366657220746f206e6f6e2d4552433131353560008201527f526563656976657220696d706c656d656e746572000000000000000000000000602082015250565b6000614c48603483612d63565b9150614c5382614bec565b604082019050919050565b60006020820190508181036000830152614c7781614c3b565b9050919050565b7f455243313135353a204552433131353552656365697665722072656a6563746560008201527f6420746f6b656e73000000000000000000000000000000000000000000000000602082015250565b6000614cda602883612d63565b9150614ce582614c7e565b604082019050919050565b60006020820190508181036000830152614d0981614ccd565b9050919050565b7f2700000000000000000000000000000000000000000000000000000000000000600082015250565b6000614d46600183613c82565b9150614d5182614d10565b600182019050919050565b6000614d6782614d39565b9150614d738284613c8d565b9150614d7e82614d39565b915081905092915050565b6000614d958286613c8d565b9150614da0826144bf565b9150614dac8285613c8d565b9150614db7826144bf565b9150614dc38284613c8d565b9150819050949350505050565b600060a082019050614de5600083018861387e565b614df2602083018761387e565b614dff6040830186612ea8565b614e0c6060830185612ea8565b8181036080830152614e1e8184614a4a565b9050969550505050505056fea2646970667358221220dbf25963473f204aad0e202f4a315f6fbe729fad48a716a3d7263ba2e0d309a464736f6c63430008120033"; // update bytecode

const controllerBytecode = "608060405234801561001057600080fd5b5033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610f7b806100616000396000f3fe6080604052600436106100555760003560e01c80633791dc6a1461005a57806366df322e1461008a57806369fe0e2d146100ba5780638da5cb5b146100e3578063d97cd55f1461010e578063ddca3f4314610137575b600080fd5b610074600480360381019061006f91906105e5565b610162565b6040516100819190610816565b60405180910390f35b6100a4600480360381019061009f919061086e565b61016f565b6040516100b19190610816565b60405180910390f35b3480156100c657600080fd5b506100e160048036038101906100dc91906108ae565b610364565b005b3480156100ef57600080fd5b506100f86103c8565b60405161010591906108ea565b60405180910390f35b34801561011a57600080fd5b5061013560048036038101906101309190610b64565b6103ee565b005b34801561014357600080fd5b5061014c610531565b6040516101599190610bcf565b60405180910390f35b61016a610537565b600080fd5b610177610537565b60005434146101bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101b290610c47565b60405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036102b9576040518060c00160405280600115158152602001600115158152602001600115158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff81111561027b5761027a61090a565b5b6040519080825280602002602001820160405280156102ae57816020015b60608152602001906001900390816102995790505b50815250905061035e565b6040518060c00160405280600115158152602001600115158152602001600115158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff8111156103245761032361090a565b5b60405190808252806020026020018201604052801561035757816020015b60608152602001906001900390816103425790505b5081525090505b92915050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103be57600080fd5b8060008190555050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461044857600080fd5b80600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160000160016101000a81548160ff02191690831515021790555060408201518160000160026101000a81548160ff02191690831515021790555060608201518160010190816104fd9190610e73565b5060808201518160020190816105139190610e73565b5060a08201518160030190816105299190610e73565b509050505050565b60005481565b6040518060c001604052806000151581526020016000151581526020016000151581526020016060815260200160608152602001606081525090565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006105b282610587565b9050919050565b6105c2816105a7565b81146105cd57600080fd5b50565b6000813590506105df816105b9565b92915050565b6000602082840312156105fb576105fa61057d565b5b6000610609848285016105d0565b91505092915050565b60008115159050919050565b61062781610612565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561066757808201518184015260208101905061064c565b60008484015250505050565b6000601f19601f8301169050919050565b600061068f8261062d565b6106998185610638565b93506106a9818560208601610649565b6106b281610673565b840191505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60006106f58383610684565b905092915050565b6000602082019050919050565b6000610715826106bd565b61071f81856106c8565b935083602082028501610731856106d9565b8060005b8581101561076d578484038952815161074e85826106e9565b9450610759836106fd565b925060208a01995050600181019050610735565b50829750879550505050505092915050565b600060c083016000830151610797600086018261061e565b5060208301516107aa602086018261061e565b5060408301516107bd604086018261061e565b50606083015184820360608601526107d58282610684565b915050608083015184820360808601526107ef8282610684565b91505060a083015184820360a0860152610809828261070a565b9150508091505092915050565b60006020820190508181036000830152610830818461077f565b905092915050565b6000819050919050565b61084b81610838565b811461085657600080fd5b50565b60008135905061086881610842565b92915050565b600080604083850312156108855761088461057d565b5b6000610893858286016105d0565b92505060206108a485828601610859565b9150509250929050565b6000602082840312156108c4576108c361057d565b5b60006108d284828501610859565b91505092915050565b6108e4816105a7565b82525050565b60006020820190506108ff60008301846108db565b92915050565b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61094282610673565b810181811067ffffffffffffffff821117156109615761096061090a565b5b80604052505050565b6000610974610573565b90506109808282610939565b919050565b600080fd5b61099381610612565b811461099e57600080fd5b50565b6000813590506109b08161098a565b92915050565b600080fd5b600080fd5b600067ffffffffffffffff8211156109db576109da61090a565b5b6109e482610673565b9050602081019050919050565b82818337600083830152505050565b6000610a13610a0e846109c0565b61096a565b905082815260208101848484011115610a2f57610a2e6109bb565b5b610a3a8482856109f1565b509392505050565b600082601f830112610a5757610a566109b6565b5b8135610a67848260208601610a00565b91505092915050565b600060c08284031215610a8657610a85610905565b5b610a9060c061096a565b90506000610aa0848285016109a1565b6000830152506020610ab4848285016109a1565b6020830152506040610ac8848285016109a1565b604083015250606082013567ffffffffffffffff811115610aec57610aeb610985565b5b610af884828501610a42565b606083015250608082013567ffffffffffffffff811115610b1c57610b1b610985565b5b610b2884828501610a42565b60808301525060a082013567ffffffffffffffff811115610b4c57610b4b610985565b5b610b5884828501610a42565b60a08301525092915050565b60008060408385031215610b7b57610b7a61057d565b5b6000610b89858286016105d0565b925050602083013567ffffffffffffffff811115610baa57610ba9610582565b5b610bb685828601610a70565b9150509250929050565b610bc981610838565b82525050565b6000602082019050610be46000830184610bc0565b92915050565b600082825260208201905092915050565b7f7061792066656520746f20696e73657274000000000000000000000000000000600082015250565b6000610c31601183610bea565b9150610c3c82610bfb565b602082019050919050565b60006020820190508181036000830152610c6081610c24565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610cae57607f821691505b602082108103610cc157610cc0610c67565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610d297fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610cec565b610d338683610cec565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610d70610d6b610d6684610838565b610d4b565b610838565b9050919050565b6000819050919050565b610d8a83610d55565b610d9e610d9682610d77565b848454610cf9565b825550505050565b600090565b610db3610da6565b610dbe818484610d81565b505050565b5b81811015610de257610dd7600082610dab565b600181019050610dc4565b5050565b601f821115610e2757610df881610cc7565b610e0184610cdc565b81016020851015610e10578190505b610e24610e1c85610cdc565b830182610dc3565b50505b505050565b600082821c905092915050565b6000610e4a60001984600802610e2c565b1980831691505092915050565b6000610e638383610e39565b9150826002028217905092915050565b610e7c8261062d565b67ffffffffffffffff811115610e9557610e9461090a565b5b610e9f8254610c96565b610eaa828285610de6565b600060209050601f831160018114610edd5760008415610ecb578287015190505b610ed58582610e57565b865550610f3d565b601f198416610eeb86610cc7565b60005b82811015610f1357848901518255600182019150602085019450602081019050610eee565b86831015610f305784890151610f2c601f891682610e39565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220f6b3dcc35ac6b7418671dedc92e9dd62a6e853d95b1c3559cbd969d8e5cac92164736f6c63430008120033"

// Connect to the database
const db = new Database();

var provider;
var signer;

const routerContractAddress = "0x2AF7341E4387e9bD2D02Dc72236af7fa6C16A6C9";

const marketplaceContractAddress = "0xEBB01Dfdb8061dD019E2bE31d689C1c6D2bf7F27";
const registryAddress = "0x4b48841d4b32C4650E4ABc117A03FE8B51f38F68";

// export const connectWallet = async () => {
//     provider = new ethers.BrowserProvider(window.ethereum);
  
//     await provider.send("eth_requestAccounts", []);
  
//     signer = await provider.getSigner();
  
//     console.log(signer);
// }

export const connectWallet = async() => {
  // provider = new ethers.BrowserProvider(window.ethereum);
  try {
      if (window.lukso) { // connecting to UP extension instead of metamask
          provider = new ethers.BrowserProvider(window.lukso);
          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
      } else if(window.ethereum) { // in case of no UP extension use metamask
          provider = new ethers.BrowserProvider(window.ethereum);
          const currentNetwork = await provider.getNetwork();
          const _currentNetworkId = currentNetwork.chainId;
          const currentNetworkId = Number(_currentNetworkId);
          if (currentNetworkId === 4201) { // checking if the network is available on the wallet
              await provider.send("eth_requestAccounts", []);
              signer = await provider.getSigner();
          } else {
              const switchLuksoTestnet = {
                  chainId: '4201',
              }
              try {
                  await ethereum.request({
                      method: 'wallet_switchEthereumChain',
                      params: [{ chainId: '4201' }],
                  });
                  await provider.send("eth_requestAccounts", []);
                  signer = await provider.getSigner();
              } catch (switchError) {
                  if (switchError.code === 4902) {
                      try {
                          await ethereum.request({
                              method: 'wallet_addEthereumChain',
                              params: [
                                  {
                                    chainId: '4201',
                                    chainName: 'LUKSO testnet',
                                    rpcUrls: ['https://rpc.testnet.lukso.network'],
                                  },
                                ],
                          });
                          await ethereum.request({
                              method: 'wallet_switchEthereumChain',
                              params: [{ chainId: '4201' }],
                          });
                          await provider.send("eth_requestAccounts", []);
                          signer = await provider.getSigner();
                      } catch (error) {
                          console.log(error);
                      }
                  } else {
                      console.log(switchError);
                  }
              }
              await window.ethereum.request({
                  method: 'wallet_switchEthereumChain',
                  params: [{ chainId: luksoTestnet.chainId }],
                });
          }
      }
      else {
          return("No wallet installed");
      }
  } catch (error) {
      console.error(error);
  }
}

export const getUser = () => {
    return [provider, signer];
}

export const getUserAddress = async () => {
    const address = await signer.address;
    return address;
}

function getInputs(questions, inputTypes) {
    const modifiedQuestions = questions.map((question, i) => {
        const modifiedQuestion = question.replace(/\s/g, '_');
        const inputType = inputTypes[i];
        return `${modifiedQuestion}${inputType}`;
    });
  
    const modifiedInputTypes = inputTypes.map((inputType) => {
      // Change "file" to "text"
      if (inputType === "file") {
        return "text";
      }
      // Change "number" to "integer"
      else if (inputType === "number") {
        return "integer";
      }
      // Leave other input types unchanged
      else {
        return inputType;
      }
    });
  
    return [modifiedQuestions, modifiedInputTypes];
}

function concatCreationArray(fields, types) {
    if (fields.length !== types.length) {
      throw new Error('Fields and types arrays must have the same length');
    }
  
    let queryString = '';
  
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += `${fields[i]} ${types[i]}`;
      } else {
        queryString += `${fields[i]} ${types[i]},`;
      }
    }
  
    return queryString;
}

function concatWriteArray(fields) {
    let queryString = '';
    
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += fields[i];
      } else {
        queryString += fields[i] + ',';
      }
    }
    
    return queryString;
}

const create = async (_questions, _inputTypes, _name, details,  contractAddress) => { // add the fee and reward feature
    const [questions, inputTypes] = getInputs(_questions, _inputTypes);
    // construct contract
    const formContract = new ethers.Contract(contractAddress, formABI, signer);
    // get create string
    const createString = concatCreationArray(questions, inputTypes);
    const writeString = concatWriteArray(questions);
    const name = _name.replace(/\s/g, '_');
    // call function to create table
    const tx = await formContract.createTable(name, createString, details, writeString);
    const receipt = await tx.wait();
    console.log(name, writeString);
    return[receipt, name];
}

const deploy = async () => {
  const ControllerInstance = new ethers.ContractFactory(controllerABI, controllerBytecode, signer);
  const controllerInstance = await ControllerInstance.deploy();
  const controllerAddress = await controllerInstance.getAddress();

  const ContractInstance = new ethers.ContractFactory(formABI, bytecode, signer);
  const contractInstance = await ContractInstance.deploy(routerContractAddress, controllerAddress, registryAddress, marketplaceContractAddress);

  const contractAddress = await contractInstance.getAddress();

  console.log(contractAddress);
  return [contractAddress, controllerAddress];
}

export const createForm = async (_questions, _inputTypes, name, details, _fee) => {
    await connectWallet();
    let receipt;
    let formName;
    let newContractAddress;
    let controllerAddress;

    const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
    const userAddress = await getUserAddress();
    const _userAddress = userAddress.toString();
    const contractAddress = await routerContract.getContract(_userAddress);

    if (contractAddress == '0x0000000000000000000000000000000000000000') {
        [newContractAddress, controllerAddress] = await deploy();
        const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
        const fee = ethers.parseEther(_fee);
        await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, newContractAddress);
        console.log(receipt);
        return formName;
    } else {
      const formContract = new ethers.Contract(contractAddress, formABI, signer);
      const controllerAddress = await formContract.controllerContract();
      const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
      const fee = ethers.parseEther(_fee.toString());
      await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, contractAddress);
        console.log(receipt);
        return formName;
    }
}

function processInputString(inputString) {
  // Split the input string by ","
  const parts = inputString.split(',');

  // Define a regular expression to match "text", "number", or "file" at the end of a word
  const regex = /(text|number|file)$/;

  // Initialize the result array
  const result = [];

  // Process each part
  for (const part of parts) {
      // Remove "_" and convert to lowercase
      const cleanedPart = part.replace(/_/g, ' ').toLowerCase();

      // Check if the cleaned part ends with "text", "number", or "file"
      const match = cleanedPart.match(regex);

      if (match) {
          // Extract the question by removing the matched suffix
          const question = cleanedPart.replace(match[0], '').trim();

          // Create an object and push it to the result array
          result.push({ question, inputType: match[0] });
      }
  }

  return result;
}

// create function to get a form
// get table contract and id using tableName(get TableName from search params)
// construct contract
// get questions and by types by separating the question from the '(inputType)' get them and concat to arrays then return them
export const getForm = async (tableName) => {
    let _tableName;
    let formContractAddress;
    let _tableId;
    let formOwner;
    let tableId;
    let tableDescription;
    let _columns;
    let responseCount;
    const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk")
    
    const routerContract = new ethers.Contract(routerContractAddress, routerABI, alchemyProvider);
    [_tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
    const formContract = new ethers.Contract(formContractAddress, formABI, alchemyProvider);
    [tableId, _tableName, tableDescription, _columns, responseCount] = await formContract.getTable(_tableId);

    const tableName_ = _tableName.replace(/_/g, ' ');
    const formInfo = [tableName_, tableDescription]
    const questions = processInputString(_columns);
    console.log(questions, formInfo);
    return [questions, formInfo];
}

export const storeFiles = async (files) => {
  try {
    const apiToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkaWQ6ZXRocjoweEU2YTk4NDRCNWZGYjg3NzhkRGZEYTc3RkJiQzhmRjI1ODk4MzFFYTUiLCJpc3MiOiJ3ZWIzLXN0b3JhZ2UiLCJpYXQiOjE2OTU2MzUwMTMyOTcsIm5hbWUiOiJEZUZvcm0ifQ.pjouYwZNbsvuI088BsweD-0v8lhwP-DqYPQsYVaXfHU"; 
    const client = new Web3Storage({ token: apiToken });
    const cid = await client.put(files);
    console.log("stored files with cid:", cid);
    console.log(cid);
    return cid;
  } catch (error) {
    console.log(error);
  }
}

// create function to get responses from users
const getResponse = async (array) => {
    const responses = [];
    // run through the array to check if the answer is a file
    for (const item of array) {
        let response;
        console.log(item)
        console.log(item.answer.constructor)
        console.log(item.answer instanceof File)
        if (typeof item.answer === 'number') {
            response = item.answer.toString();
        } else {
            response = item.answer;
        }
        responses.push(response);
    }
    console.log(responses);
    return responses
}

export const submitForm = async (tableName, _responses) => {
  let tableId;
  let formContractAddress;
  let formOwner;
  // const gasLimit = 300000;
  // const gasPriceInWei = ethers.parseUnits('25', 'gwei');
  await connectWallet();
  const responses = await getResponse(_responses);
  const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
  [tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
  const formContract = new ethers.Contract(formContractAddress, formABI, signer);
  const controllerAddress = await formContract.controllerContract();
  const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
  const fee = await controllerContract.fee();
  const tx = await formContract.writeTable(tableId, responses,
  {value: fee})
  const receipt = await tx.wait();
  console.log(receipt, responses, controllerAddress);
}

export const shortenUrl = async (longUrl) => {
  const bitlyAccessToken = "a8bedc3b5fde1d3b1f381b54c169ac09187ecd13";

  try {
    const response = await axios.post(
      'https://api-ssl.bitly.com/v4/shorten',
      {
        long_url: longUrl,
        domain: 'bit.ly', // You can specify a custom domain if you have one
      },
      {
        headers: {
          Authorization: `Bearer ${bitlyAccessToken}`,
        },
      }
    );

    return response.data.link;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}

const trimForm = async (arr) => {
  // Check if the array has at least 4 elements
  if (arr.length >= 4) {
    // Create a new array by filtering out the element at index 3 (4th element)
    return arr.filter((_, index) => index !== 3);
  }
  return arr;
}

// function to return all forms of a user
export const getUserForms = async (formOwner) => {
  const resultArray = [];

  try {
    const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk");

    const routerContract = new ethers.Contract(routerContractAddress, routerABI, alchemyProvider);

    const userContract = await routerContract.getContract(formOwner);
    const formContract = new ethers.Contract(userContract, formABI, alchemyProvider);

    const _tableCount = await formContract.getCount();
    const tableIndex = Number(_tableCount);

    for (let index = 0; index < tableIndex; index++) {
      const _table = await formContract.getTable(index);
      const table = await trimForm(_table);
      resultArray.push(table);
    }
    console.log(resultArray);
    return resultArray;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}

export const getResponses = async (params) => {
  let id;
  let address;
  let responses;
  let details;
  let userContract;
  [id, address] = splitString(params);

  [responses, details, userContract] = await getDetails(id, address);
  console.log(responses, details);
  return [responses, details, userContract];
}

// split the params
export function splitString(inputString) {
  const parts = inputString.split('0x');
  if (parts.length === 2) {
    const firstPart = parseInt(parts[0], 16); // Convert the first part to a number
    const secondPart = '0x' + parts[1]; // Keep the second part as a string
    return [firstPart, secondPart];
  } else {
    // Handle invalid input
    return null;
  }
}

async function getDetails(id, address) {
  let _tableName;
  let tableDescription;
  let tableId;
  let columns;
  let responseCount;
  const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk")
  const routerContract = new ethers.Contract(routerContractAddress, routerABI, alchemyProvider);

  const userContract = await routerContract.getContract(address);
  const formContract = new ethers.Contract(userContract, formABI, alchemyProvider);
  [tableId, _tableName, tableDescription, columns, responseCount] = await formContract.getTable(id);
  const tableName = _tableName.replace(/_/g, ' ');
  const details = [tableName, tableDescription];
  const tablelandName = await formContract.getTableName(id);
  const _responses = await db.prepare(`SELECT * FROM ${tablelandName};`).all();
  const responses = _responses.results;
  return [responses, details, userContract];
}

export const getFormsForSale = async () => {
  const resultArray = [];
  // get counter
  try {
    const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk");

    const marketplaceContract = new ethers.Contract(marketplaceContractAddress, marketABI, alchemyProvider);

    const _itemCount = await marketplaceContract.getCount();
    const itemCount = Number(_itemCount);

    for (let i = 0; i < itemCount; i++) {
      const item = await marketplaceContract.getDataset(i);
      resultArray.push(item) 
    }
    console.log(resultArray);
    return resultArray;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}

export const listDataset = async (id, formAddress) => {
  await connectWallet();
  const price = ethers.parseEther("0.001");
  const formContract = new ethers.Contract(formAddress, formABI, signer);
  const tx = await formContract.listTable(id, price);
  const receipt = await tx.wait();
  console.log(receipt);
}

export const buyDataset = async (id) => {
    await connectWallet();
    const marketplaceContract = new ethers.Contract(marketplaceContractAddress, marketABI, signer);
    const tx = await marketplaceContract.buyDataset(id);
    const receipt = await tx.wait();
    console.log(receipt);
}